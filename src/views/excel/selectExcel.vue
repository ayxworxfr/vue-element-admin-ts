<template>
  <div class="app-container">
    <!-- $t is vue-i18n global function to translate lang -->
    <el-input :placeholder="$t('excel.placeholder')" v-model="filename" style="width:340px;"
              prefix-icon="el-icon-document"/>
    <el-button :loading="downloadLoading" style="margin-bottom:20px" type="primary" icon="document"
               @click="handleDownload">{{ $t('excel.selectedExport') }}
    </el-button>
    <a href="https://panjiachen.github.io/vue-element-admin-site/feature/component/excel.html" target="_blank"
       style="margin-left:15px;">
      <el-tag type="info">Documentation</el-tag>
    </a>
    <el-table
      v-loading="listLoading"
      ref="multipleTable"
      :data="list"
      element-loading-text="拼命加载中"
      border
      fit
      highlight-current-row
      @selection-change="handleSelectionChange">
      <el-table-column type="selection" align="center"/>
      <el-table-column align="center" label="Id" width="95">
        <template slot-scope="scope">
          {{ scope.$index }}
        </template>
      </el-table-column>
      <el-table-column label="Title">
        <template slot-scope="scope">
          {{ scope.row.title }}
        </template>
      </el-table-column>
      <el-table-column label="Author" width="110" align="center">
        <template slot-scope="scope">
          <el-tag>{{ scope.row.author }}</el-tag>
        </template>
      </el-table-column>
      <el-table-column label="Readings" width="115" align="center">
        <template slot-scope="scope">
          {{ scope.row.pageviews }}
        </template>
      </el-table-column>
      <el-table-column align="center" label="PDate" width="220">
        <template slot-scope="scope">
          <i class="el-icon-time"/>
          <span>{{ scope.row.display_time }}</span>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script lang="ts">
  import { Component, Vue } from 'vue-property-decorator';
  import { IListQuery } from '@/interface';
  import { ElTable } from 'element-ui/types/table';
  import {SUCCESS_STATUS} from '@/constant';

  @Component
  export default class SelectExcel extends Vue {
    list: any[] = [];
    listLoading: boolean = true;
    multipleSelection: any[] = [];
    downloadLoading: boolean = false;
    filename: string = '';
    listQuery: IListQuery = {
      page: 1,
      limit: 20
    };
    $refs!: {
      multipleTable: ElTable
    };

    created() {
      this.fetchData();
    }

    fetchData() {
      this.listLoading = true;
      this.$services.articleList({data: this.listQuery, method: 'get'}).then((response) => {
        const {code, data} = response;
        if (code === SUCCESS_STATUS) {
          this.list = data.items;
        } else {
          this.list = [];
        }
        this.listLoading = false;
      });
    }

    handleSelectionChange(val) {
      this.multipleSelection = val;
    }

    handleDownload() {
      if (this.multipleSelection.length) {
        this.downloadLoading = true;
        import('@/assets/js/export2Excel.js').then((excel) => {
          const tHeader = ['Id', 'Title', 'Author', 'Readings', 'Date'];
          const filterVal = ['id', 'title', 'author', 'pageviews', 'display_time'];
          const list = this.multipleSelection;
          const data = this.formatJson(filterVal, list);
          excel.export_json_to_excel({
            header: tHeader,
            data,
            filename: this.filename
          });
          this.$refs.multipleTable.clearSelection();
          this.downloadLoading = false;
        });
      } else {
        this.$message({
          message: 'Please select at least one item',
          type: 'warning'
        });
      }
    }

    formatJson(filterVal, jsonData) {
      return jsonData.map((v) => filterVal.map((j) => v[j]));
    }
  }
</script>
